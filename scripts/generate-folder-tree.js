#!/usr/bin/env node
// scripts/generate-html-tree.js
// Usage:
// node generate-html-tree.js <inputPath> <outputPath> [--depth <number>]

const fs = require("fs");
const path = require("path");
const ensureDirs = require("./utils/ensure-generated-dirs");

const rootDir = process.argv[2] || ".";
const outputPath = process.argv[3] || "folder-tree.html";
const depthArgIndex = process.argv.indexOf("--depth");
const maxDepth = depthArgIndex !== -1 ? parseInt(process.argv[depthArgIndex + 1]) : Infinity;

const indentUnit = "│   ";

// --- Ensure output folder exists ---
ensureDirs(path.dirname(outputPath));

// 🎨 Styling for <pre>
const preStyle = `
  font-family: 'Fira Code', 'Consolas', 'Courier New', monospace;
  font-size: 14px;
  line-height: 1.5;
  color: #eaeaea;
  background-color: #1e1e1e;
  padding: 1rem;
  border-radius: 10px;
  overflow-x: auto;
`;

/**
 * Generate a visual folder tree.
 * Folders first, then files. Both groups sorted alphabetically (A–Z).
 */
function generateTree(dir, prefix = "", depth = 1) {
    if (depth > maxDepth) return "";

    // --- Read directory entries ---
    let entries = fs
        .readdirSync(dir, { withFileTypes: true })
        .filter((e) => !e.name.startsWith(".") && e.name !== "node_modules" && e.name !== "dist");

    // --- Sort alphabetically (folders first, files after) ---
    entries = entries.sort((a, b) => {
        if (a.isDirectory() && !b.isDirectory()) return -1;
        if (!a.isDirectory() && b.isDirectory()) return 1;
        return a.name.localeCompare(b.name, undefined, { sensitivity: "base" });
    });

    let tree = "";

    entries.forEach((entry, index) => {
        const isLast = index === entries.length - 1;
        const pointer = isLast ? "└── " : "├── ";
        const fullPath = path.join(dir, entry.name);
        const relPath = "./" + path.relative(rootDir, fullPath).replace(/\\/g, "/");

        if (entry.isDirectory()) {
            tree += `${prefix}${pointer}📁 <a href="${relPath}/">${entry.name}/</a>\n`;
            tree += generateTree(fullPath, prefix + (isLast ? "    " : indentUnit), depth + 1);
        } else {
            tree += `${prefix}${pointer}📄 <a href="${relPath}">${entry.name}</a>\n`;
        }
    });

    return tree;
}

// --- Build HTML output ---
const treeContent = `
<!-- Auto-generated by generate-html-tree.js -->
<pre style="${preStyle}">
📦 <strong>${path.basename(path.resolve(rootDir))}/</strong>
${generateTree(rootDir)}</pre>
`;

fs.writeFileSync(outputPath, treeContent, "utf8");

console.log(`✅ Folder tree saved to: ${outputPath}`);
console.log(`📏 Max depth: ${maxDepth === Infinity ? "unlimited" : maxDepth}`);
